#!usr/bin/env Rscript

suppressPackageStartupMessages({
  library(readr)
  library(readxl)
  library(datasets)
  library(tidyverse)
  library(janitor)
  library(lubridate)
})

# ---------- Inputs ----------
raw_mortality <- "Data/raw/data-table.csv"
raw_laws_xlsx <- "Data/raw/TL-A243-2-v3 State Firearm Law Database 5.0.xlsx"
laws_sheet <- "Database"

# ---------- Output ----------
out_path <- "Data/processed/firearm_data_cleaned.csv"

# ---------- Load ----------
if(!file.exists(raw_mortality)) stop("Missing input:", raw_mortality)
if(!file.exists(raw_laws_xlsx)) stop("Missing input:", raw_laws_xlsx)

mortality_data <- read.csv(raw_mortality)
law_data <- read_excel(raw_laws_xlsx, sheet = laws_sheet)

# ---------- Prep ----------
law_data <- law_data %>% janitor::clean_names()

# Keep specific columns
law_data2 <- law_data[, c("law_id", "state", "effective_date_year", 
                          "law_class_num", "law_class", "law_class_subtype", 
                          "effect", "type_of_change")]

# Map state abbreviations -> full name, fill DC
mortality_data$STATE_NAME <- datasets::state.name[
  match(toupper(mortality_data$STATE), datasets::state.abb)
]
mortality_data$STATE_NAME[is.na(mortality_data$STATE_NAME)] <- "District of Columbia"

# Convert "DEATHS" column to numeric type
mortality_data <- mortality_data %>%
  mutate(DEATHS = as.numeric(gsub("[^0-9.]", "", DEATHS)))

# Clean and standardize categorical cols in laws
law_data2 <- law_data2 %>%
  mutate(
    law_class = str_trim(str_to_title(law_class)),
    law_class_subtype = str_trim(str_to_title(law_class_subtype)),
    effect = str_trim(str_to_title(effect)),
    type_of_change = str_trim(str_to_title(type_of_change))
  )

# Create state-year grid based on mortality data
state_year_grid <- mortality_data %>%
  distinct(STATE_NAME, YEAR) %>%
  rename(state = STATE_NAME, year = YEAR)

# ---------- Scoring ----------
# Create law strength scoring system
# Restrictive laws (implement/modify): +1 point (increase gun control)
# Permissive Laws (implement/modify): -1 point (decrease gun control)
# Repeal flips sign accordingly
law_scores <- law_data2 %>%
  mutate(
    law_score = case_when(
      effect == "Restrictive" & type_of_change %in% c("Implement", "Modify") ~ 1,
      effect == "Permissive" & type_of_change %in% c("Implement", "Modify") ~ -1,
      type_of_change == "Repeal" & effect == "Restrictive" ~ -1, # Repealing restrictive law = less control
      type_of_change == "Repeal" & effect == "Permissive" ~ 1, # Repealing permissive law = more control
      TRUE ~ 0 # Handle "see note" and other cases
    )
  ) %>%
  # Remove laws with zero score that cannot be categorized
   filter(law_score != 0)


# For each state-year combination, calculate cumulative law strength
# A law affects all years from its effective year and onward
law_strength_by_year <- state_year_grid %>%
  left_join(
    law_scores %>% select(law_id, state, effective_date_year, law_class, law_class_subtype, effect, type_of_change, law_score),
    by = "state",
    relationship = "many-to-many"
  ) %>%
  # A law affects this year if its effective year is <= current year
  filter(effective_date_year <= year | is.na(effective_date_year)) %>%
  group_by(state, year) %>%
  summarise(
    # Overall law strength score (restrictive laws - permissive laws)
    law_strength_score = sum(law_score, na.rm = TRUE),
    # Count different type of laws
    restrictive_laws = sum(law_score == 1, na.rm = TRUE),
    permissive_laws = sum(law_score == -1, na.rm = TRUE),
    total_law_changes = sum(!is.na(law_score)),
    # unique law classes affected
    unique_law_classes = n_distinct(law_class, na.rm = TRUE),
    .groups = 'drop'
  )

# Create law strength by law class (wide)
law_strength_by_class <- state_year_grid %>%
  left_join(
    law_scores %>% select(law_id, state, effective_date_year, law_class, law_score),
    by = "state",
    relationship = "many-to-many"
  ) %>%
  filter(effective_date_year <= year | is.na(effective_date_year)) %>%
  group_by(state, year, law_class) %>%
  summarise(
    class_strength = sum(law_score, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Pivot to wide format for each law class
  pivot_wider(
    names_from = law_class,
    values_from = class_strength,
    values_fill = 0,
    names_prefix = "strength_"
  ) %>%
  janitor::clean_names()


# Create counts by law class (wide)
law_counts_by_class <- state_year_grid %>%
  left_join(
    law_data2 %>% select(law_id, state, effective_date_year, law_class, effect, type_of_change),
    by = "state",
    relationship = "many-to-many"
  ) %>%
  filter(effective_date_year <= year | is.na(effective_date_year)) %>%
  group_by(state, year, law_class) %>%
  summarise(
    class_count = n_distinct(law_id, na.rm = TRUE),
    class_restrictive = sum(effect == "Restrictive" & type_of_change != "Repeal", na.rm = TRUE),
    class_permissive = sum(effect == "Permissive" & type_of_change != "Repeal", na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_wider(
    names_from = law_class,
    values_from = c(class_count, class_restrictive, class_permissive),
    values_fill = 0
  ) %>%
  janitor::clean_names()

# Combine all law strength measures
law_strength_final <- law_strength_by_year %>%
  left_join(law_strength_by_class, by = c("state", "year")) %>%
  left_join(law_counts_by_class, by = c("state", "year"))

# ---------- Merge with mortality & features ----------

gun_data_final <- mortality_data %>%
  left_join(law_strength_final, by = c("STATE_NAME" = "state", "YEAR" = "year")) %>%
  janitor::clean_names()

gun_data_final2 <- gun_data_final %>%
  select(-url) %>%
  mutate(
    state = as.factor(state),
    year = as.integer(year)
  )

# create a high_risk variable
# high_risk by year percentile (75th)
# if rate in top 25% of rate data, classify as high risk (1), low risk otherwise (0)
gun_data_final3 <- gun_data_final2 %>%
  group_by(year) %>%
  mutate(
    rate_p75 = quantile(rate, 0.75, na.rm = TRUE),
    high_risk = if_else(rate >= rate_p75, 1L, 0L)
  ) %>%
  ungroup() %>%
  select(-rate_p75)

# year-over-year changes by state 
# changes in rate and change in law strength by time 
gun_data_final4 <- gun_data_final3 %>%
  arrange(state, year) %>%
  group_by(state) %>%
  mutate(
    rate_change = rate - lag(rate),
    law_strength_change = law_strength_score - lag(law_strength_score)
  ) %>%
  ungroup() %>%
  mutate(
    restrictive_ratio = round(restrictive_laws / total_law_changes, digits = 2),
    permissive_ratio = round(permissive_laws / total_law_changes, digits = 2)
  )


# ---------- Save ----------
dir.create(dirname(out_path), showWarnings = FALSE, recursive = TRUE)
write_csv(gun_data_final4, out_path)
cat("Wrote: ", out_path, "\n", sep = "")